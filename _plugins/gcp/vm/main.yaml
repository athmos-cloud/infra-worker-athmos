prerequisites:
  - message: "You must enable the Cloud Resource Manager API to use this plugin"
    action: "gcloud services enable cloudresourcemanager.googleapis.com --project ${project_id}"
    condition:
      assert: gcloud services list --enabled --project $project_id | grep cloudresourcemanager.googleapis.com | wc -l
      equals: 1
    with_values:
      - project_id
  - message: "You must grant the roles/compute.instanceAdmin.v1 role to the user service account to use this plugin"
    action: |
      gcloud organization add-iam-policy-binding $organization_name \
      --member="user:${user_service_account_email}" --role=roles/compute.instanceAdmin.v1"
    condition:
      assert: |
        gcloud projects get-iam-policy $project_id  --flatten="bindings[].members" --format='table(bindings.role)' \
        --filter="bindings.members:${user_service_account_email}" | \
        grep roles/compute.instanceAdmin.v1 | wc -l
      equals: 1
    with_values:
      - project_id
      - user_service_account_email #user:user-870@plugin-playground.iam.gserviceaccount.com
      - organization_name
inputs:
  - name: managed
    type: boolean
    required: false
    description: "Should the VM be manageable by Athmos only"
  - name: identifier
    type: identifier
    displayName: "Identifier"
    required: true
    description: "The identifier of the VM"
  - name: zone
    type: string
    required: true
    description: "The name of the zone to which this VM belongs"
  - name: machineType
    displayName: "Machine Type"
    type: string
    required: true
    description: "The machine type of this VM"
  - name: disk
    displayName: "Disk"
    type: disk
    required: true
    description: "The disk to use for this VM"
  - name: auth
    displayName: "Authentication"
    type: list[auth]
    required: false
    description: "The username and SSH keys to use for this VM"
  - name: os
    type: os
    displayName: "Operating System"
    required: true
    description: "The OS to use for this VM"

outputs:
  - name: "Public IP"
    object:
      kind: Project
      apiVersion: gcp.crossplane.io/v1beta1
    path: "status.ipPublic"

